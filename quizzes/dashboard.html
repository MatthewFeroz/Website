<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Quiz Platform | Matt Feroz</title>
    <meta name="description" content="Your quiz dashboard - track progress and take quizzes" />
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="quiz-styles.css">
    <link rel="icon" href="../favicon.ico">
</head>
<body>
    <header class="navbar">
        <div class="nav-inner">
            <a href="/" class="nav-logo"><span class="logo-full">MATT FEROZ</span><span class="logo-short">FEROZ</span></a>
            <nav class="nav-menu">
                <a href="/coaching/" class="nav-link">Coaching</a>
                <a href="/quizzes/dashboard.html" class="nav-link nav-link-active">Dashboard</a>
                <a href="/quizzes/resources.html" class="nav-link">Resources</a>
                <a href="/contact/" class="nav-link">Contact</a>
            </nav>
        </div>
    </header>

    <main>
        <!-- Loading State -->
        <section id="loading-section" class="loading-section">
            <div class="loading-spinner"></div>
            <p>Loading your dashboard...</p>
        </section>

        <!-- Dashboard Content -->
        <section id="dashboard-section" class="dashboard" hidden>
            <div class="dashboard-inner">
                <!-- Header -->
                <div class="dashboard-header">
                    <h1>Your Dashboard</h1>
                    <div class="user-info">
                        <span class="user-email" id="user-email"></span>
                        <button class="logout-button" id="logout-button">Log Out</button>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-completed">0</div>
                        <div class="stat-label">Quizzes Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-total">0</div>
                        <div class="stat-label">Total Quizzes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value highlight" id="stat-average">-</div>
                        <div class="stat-label">Average Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-resources">0</div>
                        <div class="stat-label">Resources Unlocked</div>
                    </div>
                </div>

                <!-- Diagnostic Status Banner -->
                <div class="diagnostic-banner" id="diagnostic-banner" hidden>
                    <!-- Content set dynamically -->
                </div>

                <!-- Category Progress -->
                <div class="category-progress" id="category-progress">
                    <h2>Progress by Category</h2>
                    <div class="progress-bars" id="progress-bars">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Quiz List -->
                <div class="quiz-list-section">
                    <h2>Available Quizzes</h2>
                    <div class="quiz-grid" id="quiz-grid">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="footer-inner">
            <a href="/" class="footer-logo">MATT FEROZ</a>
            <nav class="footer-menu">
                <a href="https://www.youtube.com/@MattFeroz" target="_blank" class="footer-link">YouTube</a>
                <a href="https://www.instagram.com/mattferoz" target="_blank" class="footer-link">Instagram</a>
                <a href="/contact/" class="footer-link">Contact</a>
            </nav>
        </div>
    </footer>

    <script type="module">
        import { ConvexHttpClient } from "https://esm.sh/convex@1.31.5/browser";
        import { CONVEX_URL as CONFIG_URL, DEV_MODE, DEV_ACCESS_CODE } from "./config.js";

        // Initialize Convex client
        const CONVEX_URL = CONFIG_URL || localStorage.getItem('convex_url') || '';
        if (!CONVEX_URL) {
            window.location.href = '/quizzes/';
        }
        const client = new ConvexHttpClient(CONVEX_URL);

        // Create API references for Convex functions (proxy pattern for browser usage)
        const createApi = () => new Proxy({}, {
            get: (_, module) => new Proxy({}, {
                get: (_, func) => `${module}:${func}`
            })
        });
        const api = createApi();

        // DOM Elements
        const loadingSection = document.getElementById('loading-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const userEmailEl = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');
        const statsCompleted = document.getElementById('stat-completed');
        const statsTotal = document.getElementById('stat-total');
        const statsAverage = document.getElementById('stat-average');
        const statsResources = document.getElementById('stat-resources');
        const progressBars = document.getElementById('progress-bars');
        const quizGrid = document.getElementById('quiz-grid');
        const diagnosticBanner = document.getElementById('diagnostic-banner');

        // DEV MODE banner
        if (DEV_MODE) {
            const devBanner = document.createElement('div');
            devBanner.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#f85f00;color:#fff;text-align:center;padding:8px;font-size:14px;z-index:99999;';
            devBanner.innerHTML = 'DEV MODE ENABLED';
            document.body.prepend(devBanner);
            document.body.style.paddingTop = '36px';
        }

        // Check session and load data
        async function init() {
            let userId = localStorage.getItem('quiz_user_id');
            let userEmail = localStorage.getItem('quiz_user_email');

            // DEV MODE: Auto-login if no session
            if (DEV_MODE && !userId) {
                console.log('[DEV MODE] Auto-logging in with test code...');
                try {
                    const result = await client.mutation(api.auth.validateAccessCode, { code: DEV_ACCESS_CODE });
                    if (result.success) {
                        userId = result.userId;
                        userEmail = result.email;
                        localStorage.setItem('quiz_user_id', userId);
                        localStorage.setItem('quiz_user_email', userEmail);
                        console.log('[DEV MODE] Auto-login successful:', userEmail);
                    } else {
                        console.error('[DEV MODE] Auto-login failed:', result.error);
                        alert('Dev mode login failed: ' + result.error);
                        return;
                    }
                } catch (err) {
                    console.error('[DEV MODE] Auto-login error:', err);
                    alert('Dev mode login error. Make sure npx convex dev is running.');
                    return;
                }
            }

            if (!userId) {
                window.location.href = '/quizzes/';
                return;
            }

            try {
                console.log('[Dashboard] Loading data for userId:', userId);
                
                // In dev mode, skip session validation
                if (!DEV_MODE) {
                    console.log('[Dashboard] Validating session...');
                    const session = await client.query(api.auth.validateSession, { userId });
                    if (!session.valid) {
                        localStorage.removeItem('quiz_user_id');
                        localStorage.removeItem('quiz_user_email');
                        window.location.href = '/quizzes/';
                        return;
                    }
                }

                // Load user progress
                console.log('[Dashboard] Loading user progress...');
                let progress;
                try {
                    progress = await client.query(api.quizzes.getUserProgress, { userId });
                    console.log('[Dashboard] Progress loaded:', progress);
                } catch (progressErr) {
                    console.error('[Dashboard] Failed to load progress:', progressErr);
                    // Show dashboard anyway with empty progress
                    progress = { quizzes: [], categories: [], totalQuizzes: 0, completedQuizzes: 0 };
                }
                
                // Load available resources
                console.log('[Dashboard] Loading resources...');
                let resources = [];
                try {
                    resources = await client.query(api.resources.getAvailableResources, { userId });
                    console.log('[Dashboard] Resources loaded:', resources);
                } catch (resourceErr) {
                    console.error('[Dashboard] Failed to load resources:', resourceErr);
                }
                const unlockedCount = resources.filter(r => r.isUnlocked).length;

                // Load diagnostic results
                console.log('[Dashboard] Loading diagnostic results...');
                let diagnosticResults = null;
                try {
                    diagnosticResults = await client.query(api.diagnostic.getDiagnosticResults, { userId });
                    console.log('[Dashboard] Diagnostic results loaded:', diagnosticResults);
                } catch (diagnosticErr) {
                    console.error('[Dashboard] Failed to load diagnostic results:', diagnosticErr);
                }
                renderDiagnosticBanner(diagnosticResults);

                // Update UI
                userEmailEl.textContent = userEmail || 'User';
                
                // Stats
                statsCompleted.textContent = progress.completedQuizzes;
                statsTotal.textContent = progress.totalQuizzes;
                statsResources.textContent = unlockedCount;
                
                // Calculate average score
                const quizzesWithScores = progress.quizzes.filter(q => q.bestScore !== null);
                if (quizzesWithScores.length > 0) {
                    const avgScore = Math.round(
                        quizzesWithScores.reduce((sum, q) => sum + q.bestScore, 0) / quizzesWithScores.length
                    );
                    statsAverage.textContent = avgScore + '%';
                }

                // Category progress
                renderCategoryProgress(progress.categories);

                // Quiz grid
                renderQuizGrid(progress.quizzes);

                // Show dashboard
                loadingSection.hidden = true;
                dashboardSection.hidden = false;

            } catch (err) {
                console.error('Error loading dashboard:', err);
                loadingSection.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p style="color: #ef4444; font-size: 1.2rem; margin-bottom: 1rem;">Error Loading Dashboard</p>
                        <p style="color: #9aa0aa; margin-bottom: 0.5rem;">${err.message || 'Unknown error'}</p>
                        <p style="color: #666; font-size: 0.85rem; margin-bottom: 1.5rem;">Check browser console for details</p>
                        <a href="/quizzes/" class="primary-button">Back to Quizzes</a>
                    </div>
                `;
            }
        }

        function renderCategoryProgress(categories) {
            if (categories.length === 0) {
                progressBars.innerHTML = '<p style="color: #9aa0aa;">No categories yet</p>';
                return;
            }

            progressBars.innerHTML = categories.map(cat => `
                <div class="progress-item">
                    <div class="progress-label">
                        <span class="progress-name">${formatCategoryName(cat.category)}</span>
                        <span class="progress-count">${cat.passed}/${cat.total} passed</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${cat.percentage}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderQuizGrid(quizzes) {
            if (quizzes.length === 0) {
                quizGrid.innerHTML = '<p style="color: #9aa0aa;">No quizzes available yet</p>';
                return;
            }

            quizGrid.innerHTML = quizzes.map(quiz => {
                let statusHtml = '';
                let buttonHtml = '';

                if (quiz.passed) {
                    statusHtml = `<span class="quiz-status status-passed">âœ“ Passed (${quiz.bestScore}%)</span>`;
                    buttonHtml = `<a href="/quizzes/quiz.html?id=${quiz.quizId}" class="quiz-button quiz-button-secondary">Retake</a>`;
                } else if (quiz.attemptCount > 0) {
                    statusHtml = `<span class="quiz-status status-failed">Best: ${quiz.bestScore}%</span>`;
                    buttonHtml = `<a href="/quizzes/quiz.html?id=${quiz.quizId}" class="quiz-button quiz-button-primary">Try Again</a>`;
                } else {
                    statusHtml = `<span class="quiz-status status-new">Not started</span>`;
                    buttonHtml = `<a href="/quizzes/quiz.html?id=${quiz.quizId}" class="quiz-button quiz-button-primary">Start Quiz</a>`;
                }

                return `
                    <div class="quiz-card">
                        <div class="quiz-card-header">
                            <h3>${quiz.title}</h3>
                            <span class="difficulty-badge difficulty-${quiz.difficulty}">${quiz.difficulty}</span>
                        </div>
                        <div class="quiz-card-meta">
                            <span>${formatCategoryName(quiz.category)}</span>
                        </div>
                        <div class="quiz-card-footer">
                            ${statusHtml}
                            ${buttonHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatCategoryName(category) {
            return category
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Render diagnostic banner
        function renderDiagnosticBanner(results) {
            if (!results) {
                // No diagnostic taken yet - show prompt
                diagnosticBanner.innerHTML = `
                    <div class="diagnostic-banner-content diagnostic-banner-prompt">
                        <div class="diagnostic-banner-text">
                            <h3>Discover Your Skill Level</h3>
                            <p>Take our free diagnostic quiz to assess your strengths and get personalized recommendations.</p>
                        </div>
                        <a href="/quizzes/diagnostic.html" class="primary-button">Take Diagnostic</a>
                    </div>
                `;
            } else {
                // Show skill level
                const levelColors = {
                    beginner: '#ef4444',
                    intermediate: '#eab308',
                    advanced: '#22c55e'
                };
                diagnosticBanner.innerHTML = `
                    <div class="diagnostic-banner-content diagnostic-banner-results">
                        <div class="diagnostic-banner-level">
                            <span class="level-indicator" style="background: ${levelColors[results.overallLevel]}"></span>
                            <div>
                                <span class="level-label">Your Skill Level</span>
                                <span class="level-value">${results.overallLevel.charAt(0).toUpperCase() + results.overallLevel.slice(1)}</span>
                            </div>
                        </div>
                        <div class="diagnostic-banner-score">
                            <span class="score-value">${results.overallScore}%</span>
                            <span class="score-label">Overall Score</span>
                        </div>
                        <a href="/quizzes/diagnostic-results.html" class="secondary-button">View Details</a>
                    </div>
                `;
            }
            diagnosticBanner.hidden = false;
        }

        // Logout handler
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('quiz_user_id');
            localStorage.removeItem('quiz_user_email');
            window.location.href = '/quizzes/';
        });

        // Initialize
        init();
    </script>
</body>
</html>
