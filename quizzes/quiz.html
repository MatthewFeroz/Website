<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Quiz | Matt Feroz</title>
    <meta name="description" content="Take a quiz to test your skills" />
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="quiz-styles.css">
    <link rel="icon" href="../favicon.ico">
</head>
<body>
    <header class="navbar">
        <div class="nav-inner">
            <a href="/" class="nav-logo"><span class="logo-full">MATT FEROZ</span><span class="logo-short">FEROZ</span></a>
            <nav class="nav-menu">
                <a href="/quizzes/dashboard.html" class="nav-link">Dashboard</a>
                <a href="/quizzes/resources.html" class="nav-link">Resources</a>
            </nav>
        </div>
    </header>

    <main>
        <!-- Loading State -->
        <section id="loading-section" class="loading-section">
            <div class="loading-spinner"></div>
            <p>Loading quiz...</p>
        </section>

        <!-- Quiz Content -->
        <section id="quiz-section" class="quiz-container" hidden>
            <div class="quiz-container-inner">
                <!-- Quiz Header -->
                <div class="quiz-header">
                    <h1 id="quiz-title">Loading...</h1>
                    <div class="quiz-meta">
                        <span id="quiz-category"></span>
                        <span id="quiz-difficulty"></span>
                        <span id="quiz-passing">Passing: <span id="passing-score"></span>%</span>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="quiz-progress">
                    <div class="quiz-progress-bar">
                        <div class="quiz-progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="quiz-progress-text">
                        <span>Question <span id="current-question">1</span> of <span id="total-questions">0</span></span>
                        <span id="answered-count">0 answered</span>
                    </div>
                </div>

                <!-- Question Card -->
                <div class="question-card" id="question-card">
                    <div class="question-number" id="question-number">Question 1</div>
                    <div class="question-text" id="question-text"></div>
                    <div class="answer-options" id="answer-options">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Quiz Actions -->
                <div class="quiz-actions">
                    <button class="prev-button" id="prev-button" disabled>‚Üê Previous</button>
                    <button class="next-button" id="next-button">Next ‚Üí</button>
                    <button class="submit-button" id="submit-button" hidden>Submit Quiz</button>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results-section" class="results-section" hidden>
            <div class="results-inner">
                <div class="results-icon" id="results-icon"></div>
                <h1 class="results-title" id="results-title"></h1>
                <div class="results-score" id="results-score"></div>
                <p class="results-detail" id="results-detail"></p>
                
                <div class="results-actions">
                    <a href="/quizzes/dashboard.html" class="primary-button">Back to Dashboard</a>
                    <button class="secondary-button" id="review-button">Review Answers</button>
                </div>
            </div>
        </section>

        <!-- Review Section -->
        <section id="review-section" class="quiz-container" hidden>
            <div class="quiz-container-inner">
                <div class="quiz-header">
                    <h1>Review Your Answers</h1>
                    <p class="text-muted">See what you got right and wrong</p>
                </div>

                <div id="review-questions">
                    <!-- Dynamically populated -->
                </div>

                <div class="quiz-actions quiz-actions-centered">
                    <a href="/quizzes/dashboard.html" class="primary-button">Back to Dashboard</a>
                </div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="footer-inner">
            <a href="/" class="footer-logo">MATT FEROZ</a>
            <nav class="footer-menu">
                <a href="https://www.youtube.com/@MattFeroz" target="_blank" class="footer-link">YouTube</a>
                <a href="/contact/" class="footer-link">Contact</a>
            </nav>
        </div>
    </footer>

    <script type="module">
        import { ConvexHttpClient, anyApi } from "https://esm.sh/convex@1.31.5/browser";
        import { CONVEX_URL as CONFIG_URL, DEV_MODE, DEV_ACCESS_CODE } from "./config.js";

        // Initialize Convex client
        const CONVEX_URL = CONFIG_URL || localStorage.getItem('convex_url') || '';
        if (!CONVEX_URL) {
            window.location.href = '/quizzes/';
        }
        const client = new ConvexHttpClient(CONVEX_URL);

        // Create API references for Convex functions
        const api = anyApi;

        // DEV MODE: Auto-login if needed
        async function ensureLoggedIn() {
            let userId = localStorage.getItem('quiz_user_id');
            if (DEV_MODE && !userId) {
                console.log('[DEV MODE] Auto-logging in...');
                const result = await client.mutation(api.auth.validateAccessCode, { code: DEV_ACCESS_CODE });
                if (result.success) {
                    localStorage.setItem('quiz_user_id', result.userId);
                    localStorage.setItem('quiz_user_email', result.email);
                    return result.userId;
                }
            }
            return userId;
        }

        // Get quiz ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const quizId = urlParams.get('id');

        if (!quizId) {
            window.location.href = '/quizzes/dashboard.html';
            throw new Error('No quiz ID provided');
        }

        // State
        let quiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = {}; // { questionId: selectedOptionIndex }
        let startTime = Date.now();
        let results = null;

        // DOM Elements
        const loadingSection = document.getElementById('loading-section');
        const quizSection = document.getElementById('quiz-section');
        const resultsSection = document.getElementById('results-section');
        const reviewSection = document.getElementById('review-section');

        const quizTitle = document.getElementById('quiz-title');
        const quizCategory = document.getElementById('quiz-category');
        const quizDifficulty = document.getElementById('quiz-difficulty');
        const passingScore = document.getElementById('passing-score');
        const progressFill = document.getElementById('progress-fill');
        const currentQuestionEl = document.getElementById('current-question');
        const totalQuestionsEl = document.getElementById('total-questions');
        const answeredCountEl = document.getElementById('answered-count');
        const questionNumber = document.getElementById('question-number');
        const questionText = document.getElementById('question-text');
        const answerOptions = document.getElementById('answer-options');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const submitButton = document.getElementById('submit-button');

        // Check session and load quiz
        async function init() {
            const userId = await ensureLoggedIn();

            if (!userId) {
                window.location.href = '/quizzes/';
                return;
            }

            try {
                // Load quiz
                quiz = await client.query(api.quizzes.getQuizForTaking, { quizId });
                
                if (!quiz) {
                    alert('Quiz not found');
                    window.location.href = '/quizzes/dashboard.html';
                    return;
                }

                // Update UI
                quizTitle.textContent = quiz.title;
                quizCategory.textContent = formatCategoryName(quiz.category);
                quizDifficulty.textContent = quiz.difficulty.charAt(0).toUpperCase() + quiz.difficulty.slice(1);
                passingScore.textContent = quiz.passingScore;
                totalQuestionsEl.textContent = quiz.questions.length;

                // Start timer
                startTime = Date.now();

                // Render first question
                renderQuestion();

                // Show quiz
                loadingSection.hidden = true;
                quizSection.hidden = false;

            } catch (err) {
                console.error('Error loading quiz:', err);
                alert('Error loading quiz. Please try again.');
                window.location.href = '/quizzes/dashboard.html';
            }
        }

        function renderQuestion() {
            const question = quiz.questions[currentQuestionIndex];
            const totalQuestions = quiz.questions.length;

            // Update progress
            const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
            progressFill.style.width = progress + '%';
            currentQuestionEl.textContent = currentQuestionIndex + 1;
            
            const answeredCount = Object.keys(userAnswers).length;
            answeredCountEl.textContent = answeredCount + ' answered';

            // Update question
            questionNumber.textContent = `Question ${currentQuestionIndex + 1}`;
            questionText.textContent = question.question;

            // Render options
            const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
            answerOptions.innerHTML = question.options.map((option, index) => {
                const isSelected = userAnswers[question.id] === index;
                return `
                    <div class="answer-option ${isSelected ? 'selected' : ''}" data-index="${index}">
                        <span class="option-letter">${letters[index]}</span>
                        <span class="option-text">${option}</span>
                    </div>
                `;
            }).join('');

            // Add click handlers
            document.querySelectorAll('.answer-option').forEach(option => {
                option.addEventListener('click', () => selectAnswer(parseInt(option.dataset.index)));
            });

            // Update buttons
            prevButton.disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === totalQuestions - 1) {
                nextButton.hidden = true;
                submitButton.hidden = false;
            } else {
                nextButton.hidden = false;
                submitButton.hidden = true;
            }
        }

        function selectAnswer(optionIndex) {
            const question = quiz.questions[currentQuestionIndex];
            userAnswers[question.id] = optionIndex;
            renderQuestion();
        }

        // Navigation handlers
        prevButton.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        });

        nextButton.addEventListener('click', () => {
            if (currentQuestionIndex < quiz.questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        });

        // Submit handler
        submitButton.addEventListener('click', async () => {
            const answeredCount = Object.keys(userAnswers).length;
            const totalQuestions = quiz.questions.length;

            if (answeredCount < totalQuestions) {
                const proceed = confirm(`You've only answered ${answeredCount} of ${totalQuestions} questions. Submit anyway?`);
                if (!proceed) return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';

            try {
                const userId = localStorage.getItem('quiz_user_id');
                const timeSpent = Math.round((Date.now() - startTime) / 1000);

                // Format answers for submission
                const answers = Object.entries(userAnswers).map(([questionId, selectedOptionIndex]) => ({
                    questionId,
                    selectedOptionIndex
                }));

                results = await client.mutation(api.quizzes.submitQuiz, {
                    userId,
                    quizId,
                    answers,
                    timeSpentSeconds: timeSpent
                });

                if (results.success) {
                    showResults();
                } else {
                    alert(results.error || 'Error submitting quiz');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit Quiz';
                }

            } catch (err) {
                console.error('Error submitting quiz:', err);
                alert('Error submitting quiz. Please try again.');
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Quiz';
            }
        });

        function showResults() {
            quizSection.hidden = true;
            resultsSection.hidden = false;

            const resultsIcon = document.getElementById('results-icon');
            const resultsTitle = document.getElementById('results-title');
            const resultsScore = document.getElementById('results-score');
            const resultsDetail = document.getElementById('results-detail');

            if (results.passed) {
                resultsIcon.textContent = 'üéâ';
                resultsTitle.textContent = 'Congratulations!';
                resultsTitle.classList.add('passed');
            } else {
                resultsIcon.textContent = 'üí™';
                resultsTitle.textContent = 'Keep Practicing!';
                resultsTitle.classList.add('failed');
            }

            resultsScore.textContent = results.score + '%';
            resultsDetail.textContent = `You got ${results.correctCount} out of ${results.totalQuestions} questions correct. Passing score: ${results.passingScore}%`;
        }

        // Review button handler
        document.getElementById('review-button').addEventListener('click', () => {
            resultsSection.hidden = true;
            reviewSection.hidden = false;
            renderReview();
        });

        function renderReview() {
            const reviewQuestions = document.getElementById('review-questions');
            const letters = ['A', 'B', 'C', 'D', 'E', 'F'];

            reviewQuestions.innerHTML = results.results.map((result, index) => {
                const optionsHtml = result.options.map((option, optIndex) => {
                    let optionClass = '';
                    if (optIndex === result.correctOptionIndex) {
                        optionClass = 'correct';
                    } else if (optIndex === result.selectedOptionIndex && !result.isCorrect) {
                        optionClass = 'incorrect';
                    }

                    return `
                        <div class="answer-option ${optionClass}">
                            <span class="option-letter">${letters[optIndex]}</span>
                            <span class="option-text">${option}</span>
                        </div>
                    `;
                }).join('');

                const explanationHtml = result.explanation ? `
                    <div class="explanation-box">
                        <p><strong>Explanation:</strong> ${result.explanation}</p>
                    </div>
                ` : '';

                return `
                    <div class="question-card review-question-card">
                        <div class="question-number">Question ${index + 1} ${result.isCorrect ? '‚úì' : '‚úó'}</div>
                        <div class="question-text">${result.question}</div>
                        <div class="answer-options answer-options-disabled">
                            ${optionsHtml}
                        </div>
                        ${explanationHtml}
                    </div>
                `;
            }).join('');
        }

        function formatCategoryName(category) {
            return category
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Initialize
        init();
    </script>
</body>
</html>
